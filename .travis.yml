dist: trusty
sudo: required
addons:
  ssh_known_hosts: gps.gistda.org
language: node_js
services:
  - docker
node_js:
  - '7'
env:
  - NODE_ENV=test
before_install:
  - npm install -g codecov
install:
  - npm install
before_script:
  - npm test
  - npm run coverage
  - codecov --token=$CODECOV_TOKEN
script:
  - docker build -t gistda/gnss-udp-receiver .
after_success:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS
  - docker push gistda/gnss-udp-receiver
before_deploy:
  - openssl aes-256-cbc -K $encrypted_7c97b65118bb_key -iv $encrypted_7c97b65118bb_iv
    -in deploy_rsa.enc -out /tmp/deploy_rsa -d
  - eval "$(ssh-agent -s)"
  - chmod 600 /tmp/deploy_rsa
  - ssh-add /tmp/deploy_rsa
deploy:
  provider: script
  skip_cleanup: true
  script: ssh -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST "cd service; ./udp.sh"
  on:
    branch: master
